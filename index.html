<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Методика "Корректурная проба" – тест</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f7;
            color: #222;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 960px;
            width: 100%;
            padding: 24px 16px 40px;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            padding: 24px 20px 28px;
        }

        h1 {
            font-size: 1.4rem;
            margin: 0 0 12px;
        }

        .subtitle {
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: #555;
        }

        .note {
            font-size: 0.85rem;
            color: #777;
            margin-bottom: 16px;
        }

        .timer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 8px;
        }

        .timer {
            font-weight: 600;
            font-size: 1.1rem;
            padding: 6px 12px;
            border-radius: 999px;
            background: #f0f4ff;
        }

        .timer span {
            font-variant-numeric: tabular-nums;
        }

        .progress-bar-wrapper {
            flex: 1;
            background: #eee;
            border-radius: 999px;
            overflow: hidden;
            height: 10px;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background: #4f46e5;
            transition: width 0.3s linear;
        }

        .legend {
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .legend span {
            display: inline-flex;
            align-items: center;
            margin-right: 12px;
            gap: 4px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            display: inline-block;
        }

        .dot-sample {
            background: #f97316;
        }

        .dot-selected {
            background: #22c55e;
        }

        .grid {
            margin-top: 8px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 12px;
            background: #fafafa;
            max-height: 60vh;
            overflow: auto;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 4px;
        }

        .cell {
            min-width: 20px;
            text-align: center;
            padding: 2px 4px;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            font-size: 1rem;
        }

        .cell-sample {
            font-weight: 700;
            color: #b45309;
        }

        .cell-selected {
            background: #22c55e1a;
            border: 1px solid #22c55e;
        }

        .cell:hover {
            background: #e5e7eb;
        }

        .footer-note {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #888;
        }

        @media (max-width: 600px) {
            .card {
                padding: 18px 14px 22px;
            }
            .cell {
                min-width: 18px;
                font-size: 0.9rem;
            }
            .grid {
                max-height: 55vh;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <h1>Методика «Корректурная проба» – буквенный вариант (поминутная версия)</h1>
        <p class="subtitle">
            Последовательно выделяйте в каждом ряду те буквы, которые совпадают с первой буквой в этом ряду
            (она уже выделена другим цветом).
        </p>
        <p class="note">
            По прошествии каждой минуты в течение следующих 5 минут страница будет перезагружаться для сохранения прогресса.
            На пятой минуте вы автоматически перейдёте на страницу с результатами теста.
            После перезагрузки продолжайте работу с того места, где остановились.
        </p>

        <div class="timer-row">
            <div class="timer">
                Осталось времени: <span id="time-remaining">05:00</span>
            </div>
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <div class="legend">
            <span><span class="legend-dot dot-sample"></span> первая буква в ряду (образец)</span>
            <span><span class="legend-dot dot-selected"></span> ваш выбор (найденная буква-образец</span>
        </div>

        <div class="grid" id="letter-grid">
            <!-- Ряды букв будут сгенерированы скриптом -->
        </div>

        <p class="footer-note">
            Не пытайтесь исправлять уже сделанные отметки – просто продолжайте работу дальше.
        </p>
    </div>
</div>

<script>
    // ==========================
    // НАСТРОЙКИ ТЕСТА
    // ==========================

    // 5 минут в секундах
    const TOTAL_SECONDS = 5 * 60;

    // Конфіг: масив рядків з літерами.
    // У КОЖНОМУ РЯДКУ ПЕРША ЛІТЕРА — «ЗРАЗОК», ЇЇ ПОТРІБНО ШУКАТИ ДАЛІ В РЯДКУ.
    // Ти можеш повністю замінити ці рядки на свої.
    const ROWS = [
        "А А О Л А Н А К Р А М А С А",
        "О О А Л О О Р О Н О П О Л О",
        "К К Н Л К О К К А К Р К Л К",
        "М М М А Н М О М М Л М П М М",
        "С С А С С Н С К С О С Л С С",
        "Н Н Н О Н А Н К Н Р Н Л Н Н"
        // додай ще скільки хочеш рядків
    ];

    const STORAGE_KEY = "korrektur_test_state_v1";

    // ==========================
    // ДОПОМОЖНІ ФУНКЦІЇ
    // ==========================

    function loadState() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (e) {
            console.error("Cannot parse state", e);
            return null;
        }
    }

    function saveState(state) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
            console.error("Cannot save state", e);
        }
    }

    function initDefaultState() {
        return {
            startedAt: Date.now(),          // timestamp у мс
            selected: {},                   // "rowIndex-colIndex": true
            lastReloadMinute: -1,           // для поминутного reload
            finished: false
        };
    }

    // ==========================
    // РОБОТА З РЯДКАМИ / КЛІТИНКАМИ
    // ==========================

    function renderGrid(state) {
        const grid = document.getElementById("letter-grid");
        grid.innerHTML = "";

        ROWS.forEach((rowStr, rowIndex) => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "row";

            const letters = rowStr.split(/\s+/); // розділення по пробілах

            letters.forEach((letter, colIndex) => {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.textContent = letter;

                // позначаємо першу букву як "зразок"
                if (colIndex === 0) {
                    cell.classList.add("cell-sample");
                    // зразок не клікається
                    cell.style.cursor = "default";
                } else {
                    const id = `${rowIndex}-${colIndex}`;
                    if (state.selected[id]) {
                        cell.classList.add("cell-selected");
                    }
                    cell.addEventListener("click", () => {
                        toggleCellSelection(cell, id, state);
                    });
                }

                rowDiv.appendChild(cell);
            });

            grid.appendChild(rowDiv);
        });
    }

    function toggleCellSelection(cell, id, state) {
        if (state.selected[id]) {
            delete state.selected[id];
            cell.classList.remove("cell-selected");
        } else {
            state.selected[id] = true;
            cell.classList.add("cell-selected");
        }
        saveState(state);
    }

    // ==========================
    // ТАЙМЕР + ПЕРЕЗАВАНТАЖЕННЯ / РЕДИРЕКТ
    // ==========================

    function startTimer(state) {
        const timeLabel = document.getElementById("time-remaining");
        const progressBar = document.getElementById("progress-bar");

        function update() {
            const now = Date.now();
            const elapsed = Math.floor((now - state.startedAt) / 1000);
            let remaining = TOTAL_SECONDS - elapsed;

            if (remaining < 0) remaining = 0;

            // Оновлюємо таймер
            const minutes = String(Math.floor(remaining / 60)).padStart(2, "0");
            const seconds = String(remaining % 60).padStart(2, "0");
            timeLabel.textContent = `${minutes}:${seconds}`;

            // Прогрес-бар
            const progress = (elapsed / TOTAL_SECONDS) * 100;
            progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;

            // Логіка поминутного перезавантаження (перші 4 хвилини)
            const elapsedMinutes = Math.floor(elapsed / 60);
            if (
                elapsedMinutes >= 0 &&
                elapsedMinutes <= 4 &&      // 0,1,2,3,4 — це початки хвилин до 5-ї
                elapsedMinutes !== state.lastReloadMinute &&
                remaining > 0              // ще не закінчили тест
            ) {
                state.lastReloadMinute = elapsedMinutes;
                saveState(state);
                // Перезавантажуємо сторінку, щоб "зберегти прогрес"
                location.reload();
                return;
            }

            // Після 5 хвилин – закінчення тесту
            if (elapsed >= TOTAL_SECONDS && !state.finished) {
                state.finished = true;
                saveState(state);
                // Перехід на сторінку результатів
                window.location.href = "results.html";
                return;
            }

            if (!state.finished) {
                requestAnimationFrame(update);
            }
        }

        update();
    }

    // ==========================
    // ІНІЦІАЛІЗАЦІЯ
    // ==========================

    (function init() {
        let state = loadState();
        if (!state || state.finished) {
            state = initDefaultState();
            saveState(state);
        }
        renderGrid(state);
        startTimer(state);
    })();
</script>
</body>
</html>
